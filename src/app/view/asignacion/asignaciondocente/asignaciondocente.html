<!-- ALERTA -->
<div *ngIf="alerta().tipo" class="fixed z-50 px-4 py-2 text-white rounded shadow-lg top-5 right-5"
      [ngClass]="{
        'bg-danger': alerta().tipo === 'danger',
        'bg-success': alerta().tipo === 'success',
        'bg-info': alerta().tipo === 'info'
      }">
  {{ alerta().mensaje }}
</div>

<!-- CONTENEDOR PRINCIPAL: altura completa -->
<div class="relative flex flex-col h-screen">

  <!-- CARRUSEL SUPERIOR (FIJO) -->
  <div class="z-30 flex items-center justify-center gap-4 p-4 bg-white border-b shadow-md">
    <div class="flex items-center gap-3">
      <button class="px-3 py-1 rounded-lg hover:bg-gray-100" (click)="anteriorCarrera()" aria-label="Anterior carrera">
        ←
      </button>

      <div class="px-6 py-2 text-lg font-semibold text-red-700 bg-white rounded-md shadow-sm">
        <!-- mostrar solo 1 carrera -->
        <span *ngIf="carrerasOrdenadas.length > 0">
          {{ carrerasMap[carrerasOrdenadas[paginaActual]] || ('Carrera ' + carrerasOrdenadas[paginaActual]) }}
        </span>
        <span *ngIf="carrerasOrdenadas.length === 0">Sin carreras</span>
      </div>

      <button class="px-3 py-1 rounded-lg hover:bg-gray-100" (click)="siguienteCarrera()" aria-label="Siguiente carrera">
        →
      </button>
    </div>

    <!-- indicador 3 puntos (si hay más arriba/abajo) -->
    <div class="flex items-center gap-2">
      <span *ngIf="mostrarMasArriba" class="text-sm">⋯ arriba</span>
      <span *ngIf="mostrarMasAbajo" class="text-sm">⋯ abajo</span>
    </div>
  </div>

  <!-- CONTENIDO SCROLLEABLE -->
  <div #scrollable class="flex-1 p-6 space-y-6 overflow-y-auto bg-gray-50">
    <ng-container *ngIf="carrerasOrdenadas.length > 0">
      <!-- título se muestra en el carrusel fijo; aquí ponemos subtítulo si deseas -->
      <h2 class="pb-2 text-2xl font-bold text-red-700">
        {{ carrerasMap[carrerasOrdenadas[paginaActual]] }}
      </h2>

      <!-- ASIGNACIONES (solo la carrera actual) -->
      <ng-container *ngFor="let asig of asignacionesPorCarrera[carrerasOrdenadas[paginaActual]]">
        <div class="p-4 bg-white border shadow-sm rounded-xl">
          <div class="flex flex-col gap-3 md:flex-row md:justify-between md:items-center">
            <div>
              <h3 class="text-lg font-semibold text-red-700">
                Plan: {{ asig.plan }} | Ciclo: {{ asig.ciclo }} | Modalidad: {{ asig.modalidad }}
              </h3>
              <p class="mt-1 text-sm text-muted">
                Carrera: <span class="font-medium text-slate-800">{{ carrerasMap[asig.carreraid] || '---' }}</span>
                • Secciones: <span class="font-medium text-slate-800">{{ asig.cantidad_secciones }}</span>
              </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button class="btn btn-icon" title="Agregar sección" (click)="agregarSeccion(asig)">
                <span class="icon">＋</span>
              </button>

              <button class="btn btn-icon" title="Quitar sección" (click)="quitarSeccion(asig)">
                <span class="icon">－</span>
              </button>

              <button [ngClass]="asig.estado ? 'btn btn-danger' : 'btn btn-ghost'"
                      (click)="asig.estado ? desactivarAsignacion(asig) : activarAsignacion(asig)">
                <span class="btn-label">{{ asig.estado ? 'Desactivar' : 'Activar' }}</span>
              </button>

              <!-- toggle cursos -->
              <button class="btn btn-outline" (click)="toggleCursos(asig)">
                {{ tieneCursos(asig.id) ? 'Ocultar Cursos' : 'Ver Cursos' }}
              </button>
            </div>
          </div>

          <!-- CURSOS -->
          <div *ngIf="tieneCursos(asig.id)" class="mt-4 overflow-x-auto">
            <table class="w-full text-sm table-auto">
              <thead class="text-red-800 bg-red-50">
                <tr>
                  <th class="px-3 py-2 text-left">Curso</th>
                  <th class="px-3 py-2 text-center">Sección</th>
                  <th class="px-3 py-2 text-center">Horas</th>
                  <th class="px-3 py-2">Docente</th>
                  <th class="px-3 py-2">Bloque</th>
                  <th class="px-3 py-2 text-center">Duplica</th>
                  <th class="px-3 py-2 text-center">Horas actuales</th>
                  <th class="px-3 py-2 text-center">Horas temporales</th>
                  <th class="px-3 py-2">Ambiente</th>
                  <th class="px-3 py-2">Comentario</th>
                  <th class="px-3 py-2 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let curso of cursosPorAsignacion[asig.id]" class="border-t hover:bg-red-50">
                  <td class="px-3 py-2">{{ curso.nombreCurso }}</td>
                  <td class="px-3 py-2 text-center">{{ curso.seccion }}</td>
                  <td class="px-3 py-2 text-center">{{ curso.horas }}</td>

                  <td class="w-56 px-3 py-2">
                    <select class="w-full form-select"
                            [(ngModel)]="seleccion[curso.curso_id + '_' + curso.seccion]"
                            (change)="seleccionarDocente(curso.curso_id + '_' + curso.seccion, seleccion[curso.curso_id + '_' + curso.seccion] || null, curso)">
                      <option [ngValue]="null">-- Seleccionar --</option>
                      <option *ngFor="let d of docentes" [ngValue]="d.id">{{ d.nombre }}</option>
                    </select>
                  </td>

                  <td class="w-40 px-3 py-2">
                    <div class="flex flex-col gap-2">
                      <select class="form-select" [(ngModel)]="curso.bloque">
                        <option [ngValue]="null">-- Ninguno --</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                      </select>
                      <label class="inline-flex items-center gap-2 text-xs">
                        <input type="checkbox" class="form-checkbox" [(ngModel)]="curso.es_bloque" />
                        Bloque
                      </label>

                      <button *ngIf="curso.es_bloque"
                              class="w-full btn-sm"
                              [ngClass]="curso.activo ? 'btn btn-danger' : 'btn btn-success'"
                              (click)="toggleBloque(curso)">
                        {{ curso.activo ? 'Desactivar' : 'Activar' }}
                      </button>
                    </div>
                  </td>

                  <td class="px-3 py-2 text-center">
                    <input type="checkbox" class="form-checkbox" [(ngModel)]="curso.duplica_horas" />
                  </td>

                  <td class="px-3 py-2 text-center">{{ curso.docente?.horasactual || 0 }}</td>
                  <td class="px-3 py-2 text-center">{{ curso.docente?.horastemporales || 0 }}</td>
                  <!-- ⭐ COLUMNA AMBIENTE -->
                  <td class="w-40 px-3 py-2">
                    <select
                      class="w-full form-select"
                      [(ngModel)]="curso.tipoambiente_id"
                      (change)="curso.tipoambiente_nombre = tipoambienteMap[curso.tipoambiente_id!] || null"
                    >
                      <option [ngValue]="null">-- Seleccionar --</option>
                      <option *ngFor="let amb of tipoambiente" [ngValue]="amb.id">
                        {{ amb.nombre }}
                      </option>
                    </select>

                    <!-- Mostrar código actual -->
                    <p class="mt-1 text-xs text-gray-600" *ngIf="curso.tipoambiente_nombre">
                      Seleccionado: <strong>{{ curso.tipoambiente_nombre }}</strong>
                    </p>
                  </td>


                  <td class="w-56 px-3 py-2">
                    <textarea class="w-full form-textarea" [(ngModel)]="curso.comentario" placeholder="Comentario..."></textarea>
                  </td>

                  <td class="px-3 py-2">
                    <div class="flex flex-col gap-2">
                      <button class="btn btn-success btn-block"
                              (click)="confirmarGuardado(curso)"
                              [disabled]="!seleccion[curso.curso_id + '_' + curso.seccion]">
                        Guardar
                      </button>

                      <button class="btn btn-ghost btn-block"
                              (click)="curso.docente ? recalcularHoras(curso.docente) : null"
                              [disabled]="!curso.docente">
                        Recalcular
                      </button>
                    </div>
                  </td>

                </tr>
              </tbody>
            </table>
          </div>

          <p *ngIf="!tieneCursos(asig.id)" class="mt-3 text-sm text-muted">
            No tiene cursos guardados.
          </p>
        </div>
      </ng-container>
    </ng-container>
  </div>
</div>
